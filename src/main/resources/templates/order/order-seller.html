<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>주문서</title>
    <link rel="stylesheet" href="/css/order/order.css">

</head>
<body>
<div layout:fragment="content" class="order-wrapper">
    <div class="order-container">
        <div th:if="${successMessage}" class="message-box message-success" id="successMessageBox">
            <button type="button" class="message-close-btn" id="closeSuccess">×</button>
            <p th:text="${successMessage}"></p>
        </div>
        <div th:if="${errorMessage}" class="message-box message-error" id="errorMessageBox">
            <button type="button" class="message-close-btn" id="closeError">×</button>
            <p th:text="${errorMessage}"></p>
        </div>

        <header>
            <div th:text="${viewData.formattedCreatedAt}">2025.01.01</div>
            <div>주문번호: <span th:text="${viewData.orderId}">1</span></div>
        </header>

        <section class="card">
            <div class="status">
                <span th:text="${viewData.orderStatus}">결제 완료</span>
            </div>
            <hr class="margin-custom">
            <a th:href="|/products/${viewData.product.id}?fromOrder=true|" class="product-info">
                <img th:src="@{${viewData.product.thumbnailUrl}}" alt="상품 이미지"/>
                <div class="product-details">
                    <div class="product-name" th:text="${viewData.product.title}"></div>
                    <div class="product-price"
                         th:text="${#numbers.formatInteger(viewData.payment.amount, 3, 'COMMA')} + '원'"></div>
                </div>
            </a>
        </section>
        <!-- 후기 작성 버튼-->
        <div class="order-actions" th:if="${viewData.showWriteReviewButton}">
            <a th:href="@{/orders/{id}/reviews/new(id=${viewData.orderId})}" class="btn-common btn-confirm">후기 작성하기</a>
        </div>

        <!-- 상대 후기 보러가기 버튼-->
        <div class="order-actions" th:if="${viewData.showViewOtherReviewButton}">
            <a th:href="@{/shop/{myId}/reviews(myId=${viewData.seller.id})}" class="btn-common btn-confirm">상대방 후기
                확인하기</a>
        </div>

        <!-- 내가 쓴 후기 보러가기 버튼-->
        <div class="order-actions" th:if="${viewData.showViewMyReviewButton}">
            <a th:href="@{/shop/{otherId}/reviews(otherId=${viewData.buyer.id})}" class="btn-common btn-confirm">내 후기
                확인하기</a>
        </div>

        <div class="section-title">판매 정보</div>
        <section class="card">
            <dl>
                <dd>상품 금액: <span th:text="${#numbers.formatInteger(viewData.payment.amount, 3, 'COMMA')} + '원'"></span>
                </dd>
                <dd th:if="${viewData.payment.deliveryFee != null}">배송비: <span
                        th:text="${#numbers.formatInteger(viewData.payment.deliveryFee, 3, 'COMMA')} + '원'"></span></dd>
                <dd>결제 금액: <span
                        th:text="${#numbers.formatInteger(viewData.payment.finalAmount, 3, 'COMMA')} + '원'"></span></dd>
                <dd>결제 수단: <span th:text="${viewData.payment.payMethod}"></span></dd>
            </dl>
        </section>

        <div class="section-title" th:if="${viewData.showDeliveryInfoSection}">배송지 정보</div>
        <section class="card" th:if="${viewData.showDeliveryInfoSection}">
            <dl>
                <dd>수령인: <span th:text="${viewData.delivery.recipientName}"></span></dd>
                <dd>전화번호: <span th:text="${viewData.delivery.recipientPhone}"></span></dd>
                <dd th:if="${viewData.delivery.address != null}">주소: <span
                        th:text="${'(' + viewData.delivery.postCode + ') ' + viewData.delivery.address}"></span></dd>
                <dd th:if="${viewData.delivery.detailAddress != null}">상세주소: <span
                        th:text="${viewData.delivery.detailAddress}"></span></dd>
                <dd th:if="${viewData.delivery.storeName != null}">편의점: <span
                        th:text="${viewData.delivery.storeName}"></span><br/>주소: <span
                        th:text="${viewData.delivery.storeAddress}"></span></dd>
                <dd th:if="${viewData.delivery.requestMessage != null}">요청사항: <span
                        th:text="${viewData.delivery.requestMessage}"></span></dd>
            </dl>
        </section>

        <div class="section-title">거래 정보</div>
        <section class="card">
            <dl>
                <dd>주문번호 <span th:text="${viewData.orderId}"></span></dd>
                <dd>구매자: <a th:href="@{/shop/{id}(id=${viewData.buyer.id})}" th:text="${viewData.buyer.nickname}"></a>
                </dd>
                <dd>거래 방법: <span th:text="${viewData.payment.deliveryMethod}"></span></dd>
                <dd th:if="${viewData.delivery != null}">배송 현황: <span
                        th:text="${viewData.delivery.deliveryStatus}"></span></dd>
                <!-- 결제 완료 상태일시 뜨는 운송장 입력폼 -->
                <div th:if="${viewData.showTrackingInputForm}">
                    <form th:action="@{/orders/{id}/delivery(id=${viewData.orderId})}" method="post"
                          class="margin-top-custom">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div th:if="${viewData.isNormalDeliveryInput}">
                            <label>택배사
                                <select name="deliveryCompany" required>
                                    <option value="">-- 택배사를 선택하세요 --</option>
                                    <option value="CJ대한통운"
                                            th:selected="${viewData.delivery.deliveryCompany == 'CJ대한통운'}">
                                        CJ대한통운
                                    </option>
                                    <option value="롯데택배" th:selected="${viewData.delivery.deliveryCompany == '롯데택배'}">
                                        롯데택배
                                    </option>
                                    <option value="한진택배" th:selected="${viewData.delivery.deliveryCompany == '한진택배'}">
                                        한진택배
                                    </option>
                                    <option value="우체국택배" th:selected="${viewData.delivery.deliveryCompany == '우체국택배'}">
                                        우체국택배
                                    </option>
                                    <option value="로젠택배" th:selected="${viewData.delivery.deliveryCompany == '로젠택배'}">
                                        로젠택배
                                    </option>
                                    <option value="CU편의점택배"
                                            th:selected="${viewData.delivery.deliveryCompany == 'CU편의점택배'}">CU편의점택배
                                    </option>
                                    <option value="GS25편의점택배"
                                            th:selected="${viewData.delivery.deliveryCompany == 'GS25편의점택배'}">GS25편의점택배
                                    </option>
                                </select>
                            </label>
                        </div>

                        <div th:unless="${viewData.isNormalDeliveryInput}">
                            <label>택배사
                                <input type="text" name="deliveryCompany"
                                       th:value="${viewData.delivery.storeName.contains('CU') ? 'CU편의점택배' : 'GS25편의점택배'}"
                                       readonly>
                            </label>
                        </div>

                        <label>운송장번호
                            <input type="text" name="trackingNumber"
                                   th:value="${viewData.delivery.trackingNumber}"
                                   placeholder="'-'을 제외한 운송장번호를 입력하세요."
                                   inputmode="numeric" pattern="[0-9]*" maxlength="20" required>
                        </label>

                        <div>
                            <button type="submit">운송장 등록</button>
                        </div>
                    </form>
                </div>

                <!-- 배송중이면 택배사 및 운송장 번호 노출 -->
                <dd th:if="${viewData.showEnteredTrackingInfo}">택배사: <span th:text="${viewData.delivery.deliveryCompany}"></span></dd>
                <dd th:if="${viewData.showEnteredTrackingInfo}">운송장번호: <a th:href="${viewData.delivery.trackingUrl}" th:text="${viewData.delivery.trackingNumber}" target="_blank" class="tracking-link"></a></dd>
            </dl>
        </section>
    </div>
</div>
<script th:src="@{/js/order/order.js}"></script>
</body>
</html>
